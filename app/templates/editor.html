<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>MySub公共订阅编辑器</title>
        <!-- Bootstrap core CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
        <style>
            .link-item { 
                margin-bottom: 10px;
                cursor: move;
            }
        </style>
    </head>
    <body>
        <div class="container my-5 py-3">
            <h2>公共订阅编辑器</h2>
            <p>支持 VMESS 和 SS 分享链接。每个链接将以独立组件显示，支持添加、修改、排序操作。</p>
            
            <!-- 密钥部分 -->
            <form action="" method="post" id="accesskeyForm">
                <div class="mb-3">
                    <label for="accesskey" class="form-label">分享密钥</label>
                    <input type="text" class="form-control" id="accesskey" name="accesskey" value="{{ accesskey }}">
                </div>
                <div id="emailHelp" class="form-text">密钥以MD5形式保存, 如果忘记可以在本页面重设</div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="yes" name="dontsavekeytf" id="savekeytf">
                    <label class="form-check-label" for="savekeytf">不明文保存密码（勾选并保存将清除以前明文存储的密码）</label>
                </div>
                <button type="submit" class="btn btn-primary mt-2">立即保存</button>
                <button type="button" class="btn btn-success mt-2" onclick="generatepwd()">一键生成密钥</button>
            </form>
            
            <!-- 分享链接显示 -->
            <div class="mt-4">
                <div class="mb-3">
                    <input type="text" class="form-control" id="sharelink" value="{{ sharelink }}">
                </div>
                <div class="mb-3">
                    <input type="text" class="form-control" id="sharelink_premium" value="{{ sharelink_premium }}">
                </div>
                <button type="button" class="btn btn-success" onclick="copyLink('sharelink')">复制普通线路分享链接</button>
                <button type="button" class="btn btn-success" onclick="copyLink('sharelink_premium')">复制Premium分享链接</button>
            </div>
            
            <hr/>
            
            <!-- 普通线路编辑 -->
            <h3>普通线路</h3>
            <form action="" method="post" id="linksForm">
                <div id="linksContainer">
                    {% for link in links %}
                    <div class="link-item card p-2">
                        <div class="mb-2">
                            <label>链接:</label>
                            <input type="text" class="form-control link-url" value="{{ link.raw }}">
                        </div>
                        <div class="mb-2">
                            <label>类型:</label>
                            <span class="badge bg-secondary">{{ link.type }}</span>
                            <label>备注:</label>
                            <span class="badge bg-info">{{ link.comment }}</span>
                        </div>
                        <div>
                            <button type="button" class="btn btn-secondary btn-sm move-up">上移</button>
                            <button type="button" class="btn btn-secondary btn-sm move-down">下移</button>
                            <button type="button" class="btn btn-danger btn-sm remove-link">删除</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-primary mt-2" id="addLinkBtn">添加链接</button>
                <!-- 隐藏域保存链接 JSON -->
                <input type="hidden" name="links_json" id="linksJson">
                <button type="submit" class="btn btn-success mt-2">保存普通线路</button>
            </form>
            
            <hr/>
            
            <!-- Premium 线路编辑 -->
            <h3>Premium 线路</h3>
            <form action="" method="post" id="premiumLinksForm">
                <div id="premiumLinksContainer">
                    {% for link in links_premium %}
                    <div class="link-item card p-2">
                        <div class="row">
                            <div class="col-auto pe-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grip-vertical" viewBox="0 0 16 16">
                                    <path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0M7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0M7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0m-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0m-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
                                </svg>
                            </div>
                            <div class="col">
                                <div class="mb-2">
                                    <label>链接:</label>
                                    <input type="text" class="form-control link-url" value="{{ link.raw }}">
                                </div>
                                <div class="mb-2">
                                    <label>类型:</label>
                                    <span class="badge bg-secondary">{{ link.type }}</span>
                                    <label>备注:</label>
                                    <span class="badge bg-info">{{ link.comment }}</span>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-secondary btn-sm move-up">上移</button>
                                    <button type="button" class="btn btn-secondary btn-sm move-down">下移</button>
                                    <button type="button" class="btn btn-danger btn-sm remove-link">删除</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-primary mt-2" id="addPremiumLinkBtn">添加链接</button>
                <input type="hidden" name="links_json_premium" id="linksJsonPremium">
                <button type="submit" class="btn btn-success mt-2">保存 Premium 线路</button>
            </form>
            
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
        <script>
            
            function generatesharelink() {
                var url = '{{ sharelink.split("?key=")[0] if sharelink else "" }}';
                document.getElementById('sharelink_premium').value = url + '?key=' + document.getElementById('accesskey').value + '&level=premium';
                document.getElementById('sharelink').value = url + '?key=' + document.getElementById('accesskey').value;
            }

            function copyLink(id) {
                var copyText = document.getElementById(id);
                copyText.select();
                copyText.setSelectionRange(0, 99999);
                alert("Copied: " + copyText.value);
            }

            function generatepwd() {
                var pasArr = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'.split('');
                var password = '';
                for (var i = 0; i < 16; i++){
                    var x = Math.floor(Math.random()*pasArr.length);
                    password += pasArr[x];
                }
                document.getElementById('accesskey').value = password;
                generatesharelink();
            }
            // 初始化普通线路排序
            Sortable.create(document.getElementById('linksContainer'), {
                animation: 150
            });
          
            // 初始化 Premium 线路排序
            Sortable.create(document.getElementById('premiumLinksContainer'), {
                animation: 150
            });
            
            // 下面是原有添加/删除按钮的事件绑定代码……
            document.getElementById('addLinkBtn').addEventListener('click', function(){
                var container = document.getElementById('linksContainer');
                var newDiv = document.createElement('div');
                newDiv.className = 'link-item card p-2';
                newDiv.innerHTML = `
                    <div class="row">
                        <div class="col-auto pe-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grip-vertical" viewBox="0 0 16 16">
                                <path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0M7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0M7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0m-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0m-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
                            </svg>
                        </div>
                        <div class="col">
                            <div class="mb-2">
                            <label>链接:</label>
                            <input type="text" class="form-control link-url" value="">
                        </div>
                        <div class="mb-2">
                            <label>类型:</label>
                            <span class="badge bg-secondary">unknown</span>
                            <label>备注:</label>
                            <span class="badge bg-info"></span>
                        </div>
                        <div>
                            <button type="button" class="btn btn-secondary btn-sm move-up">上移</button>
                            <button type="button" class="btn btn-secondary btn-sm move-down">下移</button>
                            <button type="button" class="btn btn-danger btn-sm remove-link">删除</button>
                        </div>
                    </div>
                   
                `;
                container.appendChild(newDiv);
            });
            
            // 以下删除，上移，下移的按钮事件逻辑依然适用
            document.getElementById('linksContainer').addEventListener('click', function(e) {
                if(e.target.classList.contains('remove-link')) {
                   e.target.closest('.link-item').remove();
                } else if(e.target.classList.contains('move-up')) {
                   var item = e.target.closest('.link-item');
                   if(item.previousElementSibling)
                      item.parentNode.insertBefore(item, item.previousElementSibling);
                } else if(e.target.classList.contains('move-down')) {
                   var item = e.target.closest('.link-item');
                   if(item.nextElementSibling)
                      item.parentNode.insertBefore(item.nextElementSibling, item);
                }
            });
          
            // 同理，为 Premium 线路容器添加相同功能
            document.getElementById('addPremiumLinkBtn').addEventListener('click', function(){
                var container = document.getElementById('premiumLinksContainer');
                var newDiv = document.createElement('div');
                newDiv.className = 'link-item card p-2';
                newDiv.innerHTML = `
                    <div class="row">
                        <div class="col-auto pe-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grip-vertical" viewBox="0 0 16 16">
                                <path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0M7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0M7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0m-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0m-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
                            </svg>
                        </div>
                        <div class="col">
                            <div class="mb-2">
                            <label>链接:</label>
                            <input type="text" class="form-control link-url" value="">
                        </div>
                        <div class="mb-2">
                            <label>类型:</label>
                            <span class="badge bg-secondary">unknown</span>
                            <label>备注:</label>
                            <span class="badge bg-info"></span>
                        </div>
                        <div>
                            <button type="button" class="btn btn-secondary btn-sm move-up">上移</button>
                            <button type="button" class="btn btn-secondary btn-sm move-down">下移</button>
                            <button type="button" class="btn btn-danger btn-sm remove-link">删除</button>
                        </div>
                    </div>
                `;
                container.appendChild(newDiv);
            });
            
            document.getElementById('premiumLinksContainer').addEventListener('click', function(e) {
                if(e.target.classList.contains('remove-link')) {
                   e.target.closest('.link-item').remove();
                } else if(e.target.classList.contains('move-up')) {
                   var item = e.target.closest('.link-item');
                   if(item.previousElementSibling)
                      item.parentNode.insertBefore(item, item.previousElementSibling);
                } else if(e.target.classList.contains('move-down')) {
                   var item = e.target.closest('.link-item');
                   if(item.nextElementSibling)
                      item.parentNode.insertBefore(item.nextElementSibling, item);
                }
            });
            
            // 提交前将数据转换为 JSON
            document.getElementById('linksForm').addEventListener('submit', function(e) {
                var items = document.querySelectorAll('#linksContainer .link-item');
                var arr = [];
                items.forEach(function(item) {
                    var url = item.querySelector('.link-url').value.trim();
                    if(url){
                        arr.push({ raw: url });
                    }
                });
                document.getElementById('linksJson').value = JSON.stringify(arr);
            });
            
            document.getElementById('premiumLinksForm').addEventListener('submit', function(e) {
                var items = document.querySelectorAll('#premiumLinksContainer .link-item');
                var arr = [];
                items.forEach(function(item) {
                    var url = item.querySelector('.link-url').value.trim();
                    if(url){
                        arr.push({ raw: url });
                    }
                });
                document.getElementById('linksJsonPremium').value = JSON.stringify(arr);
            });
          </script>
    </body>
</html>